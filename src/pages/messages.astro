---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Messages - Freedom Stack v2">
  <main x-data="messages" class="container mx-auto p-8">
    <h1 class="text-3xl font-bold mb-6">Messages</h1>
    
    <!-- Message form -->
    <div class="mb-8 p-6 bg-gray-100 rounded-lg">
      <h2 class="text-xl font-semibold mb-4">Send a Message</h2>
      <form x-bind="$form" id="messageForm" class="space-y-4">
        <div>
          <label for="author" class="block text-sm font-medium text-gray-700">Author</label>
          <input 
            type="text" 
            id="author" 
            name="author" 
            required 
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
          />
        </div>
        <div>
          <label for="text" class="block text-sm font-medium text-gray-700">Message</label>
          <textarea 
            id="text" 
            name="text" 
            required 
            rows="3"
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
          ></textarea>
        </div>
        <button 
          type="submit" 
          class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
        >
          Send Message
        </button>
      </form>
    </div>

    <!-- Messages list -->
    <div>
      <h2 class="text-xl font-semibold mb-4">Messages</h2>
      <div id="messagesList" class="space-y-4">
        <div x-show="!messages.length">
          <div class="text-gray-500">Loading messages...</div>
        </div>
        <template x-for="message in messages" :key="message._id"> 
          <div class="bg-white p-4 rounded-lg shadow border"> 
            <div class="font-semibold text-gray-900" x-text="message.author"></div>
            <div class="text-gray-700 mt-1" x-text="message.text"></div>
            <div class="text-xs text-gray-500 mt-2" x-text="new Date(message._creationTime).toLocaleString()"></div>
          </div>
        </template>
      </div>
    </div>
  </main>

  <script>
    import Alpine from "alpinejs";
    import { ConvexClient } from "convex/browser";
    import { api } from "../../convex/_generated/api.js";
    
    // Initialize Convex client
    const convexClient = new ConvexClient(import.meta.env.PUBLIC_CONVEX_URL);
    
    document.addEventListener("alpine:init", () => {
      Alpine.data("messages", () => ({
        messages: [] as typeof api.messages.list._returnType,
        async sendMessage(author: string, text: string) {
          await convexClient.mutation(api.messages.send, { author, text });
        },
        $form: {
          async '@submit'({ target: formElement, preventDefault }: { target: HTMLFormElement, preventDefault: () => void }) {
            preventDefault();
            const formData = new FormData(formElement);
            const author = formData.get('author') as string;
            const text = formData.get('text') as string;
            await this.sendMessage(author, text);
            // Reset the form
            formElement.reset();
          }
        },
        init() {
          convexClient.onUpdate(api.messages.list, {}, (messages) => {
            this.messages = messages;
          });
        }
      }));
    });
  </script>
</Layout> 